{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center text-secondary">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h1>
    
    <div class="mb-3">
        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –¥–æ –ø–∞–Ω–µ–ª—ñ</a>
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–Ü–º'—è</th>
                    <th>Email</th>
                    <th>–ë–∞–ª–∞–Ω—Å (EUR)</th>
                    <th>–¢–∏–ø</th>
                    <th>–ê–¥–º—ñ–Ω</th>
                    <th>–í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span id="balance-{{ user.id }}">{{ user.balance | round(2) }}</span>
                    </td>
                    <td>{{ user.user_type }}</td>
                    <td>
                        <span class="badge {{ 'bg-success' if user.is_admin else 'bg-secondary' }}">
                            {{ '–¢–∞–∫' if user.is_admin else '–ù—ñ' }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {{ 'bg-success' if user.is_verified else 'bg-warning' }}">
                            {{ '–¢–∞–∫' if user.is_verified else '–ù—ñ' }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-success" onclick="adjustBalance({{ user.id }}, 'add')">+</button>
                            <button class="btn btn-sm btn-danger" onclick="adjustBalance({{ user.id }}, 'deduct')">-</button>
                            <button class="btn btn-sm btn-warning" onclick="toggleAdmin({{ user.id }})">üë§</button>
                            <button class="btn btn-sm btn-info" onclick="toggleVerified({{ user.id }})">‚úì</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
async function adjustBalance(userId, action) {
    const amount = prompt('–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É:');
    if (!amount || isNaN(amount)) return;
    
    try {
        const response = await fetch(`/admin/manage_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action === 'add' ? 'add_balance' : 'deduct_balance',
                amount: parseFloat(amount)
            })
        });
        
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó');
    }
}

async function toggleAdmin(userId) {
    if (!confirm('–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞?')) return;
    
    try {
        const response = await fetch(`/admin/manage_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'toggle_admin'
            })
        });
        
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó');
    }
}

async function toggleVerified(userId) {
    if (!confirm('–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó?')) return;
    
    try {
        const response = await fetch(`/admin/manage_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'toggle_verified'
            })
        });
        
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó');
    }
}
</script>
{% endblock %}